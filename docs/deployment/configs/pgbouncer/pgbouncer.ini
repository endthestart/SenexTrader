;; PgBouncer Configuration for Senex Trader
;; Connection pooling for PostgreSQL
;; Install: sudo apt install pgbouncer

[databases]
; Format: db_name = host=localhost port=5432 dbname=db_name
senextrader = host=localhost port=5432 dbname=senextrader user=senex_user

[pgbouncer]
;;;
;;; Administrative settings
;;;

logfile = /var/log/postgresql/pgbouncer.log
pidfile = /var/run/postgresql/pgbouncer.pid

;;;
;;; Where to listen for clients
;;;

; IP address or * for all
listen_addr = 127.0.0.1
listen_port = 6432

; Unix socket location
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777
unix_socket_group =

;;;
;;; Authentication settings
;;;

; Authentication type: trust, plain, md5, scram-sha-256, cert, hba, pam
auth_type = md5

; Authentication file for user credentials
auth_file = /etc/pgbouncer/userlist.txt

; HBA file (if auth_type = hba)
;auth_hba_file =

;;;
;;; Connection pooling
;;;

; CRITICAL: Use transaction pooling for Django
pool_mode = transaction

; Maximum number of client connections allowed
max_client_conn = 200

; Default pool size (actual PostgreSQL connections)
default_pool_size = 25

; Additional pool size for emergencies
min_pool_size = 10
reserve_pool_size = 5
reserve_pool_timeout = 3

;;;
;;; Timeouts
;;;

; Server connection idle timeout
server_idle_timeout = 600

; Maximum server connection lifetime
server_lifetime = 3600

; How long to wait for server connection
server_connect_timeout = 15

; Login retry delay
server_login_retry = 15

; Client connection idle timeout
client_idle_timeout = 0

; Client login timeout
client_login_timeout = 60

; How long to wait for query results
query_timeout = 0

; How long to wait while canceling query
query_wait_timeout = 120

;;;
;;; Dangerous timeouts
;;;

; Close server connection if no queries for this long
; (Dangerous: can break transactions)
;server_reset_query_always = 0
;server_check_delay = 30

;;;
;;; Low-level network settings
;;;

; TCP socket buffers
;pkt_buf = 4096

; TCP keepalive settings
;tcp_keepalive = 1
;tcp_keepcnt = 0
;tcp_keepidle = 0
;tcp_keepintvl = 0

; DNS lookup caching
;dns_max_ttl = 15
;dns_zone_check_period = 0

;;;
;;; TLS settings (optional)
;;;

;client_tls_sslmode = disable
;client_tls_key_file =
;client_tls_cert_file =
;client_tls_ca_file =

;server_tls_sslmode = prefer
;server_tls_ca_file =
;server_tls_key_file =
;server_tls_cert_file =

;;;
;;; Logging
;;;

; What to log
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
;log_stats = 1

; Log verbosity: 0 - ERROR, 1 - WARNING, 2 - INFO, 3 - DEBUG
verbose = 0

;;;
;;; Console access
;;;

; Users allowed to run SHOW/KILL/RELOAD/PAUSE commands
admin_users = postgres

; Users allowed to run SHOW commands
stats_users = postgres

;;;
;;; Connection sanity checks
;;;

; Check connection health
server_check_query = SELECT 1

; Disable server connection use if it fails
server_check_delay = 30

;;;
;;; Performance
;;;

; Disable expensive checks
ignore_startup_parameters = extra_float_digits

; Application name workaround for Django
; Django sets application_name which can interfere with pooling
application_name_add_host = 0

;;;
;;; Limits
;;;

; Maximum number of server connections per database
max_db_connections = 0

; Maximum number of server connections per user
max_user_connections = 0

;;;
;;; Pooling behavior
;;;

; When server connection is released back to pool,
; next query can use it immediately without waiting
; for transaction rollback
;server_reset_query = DISCARD ALL

; Defer server connection until a query arrives
;server_fast_close = 0

;;;
;;; Statistics
;;;

; Period for writing aggregated stats into log
;stats_period = 60

;;;
;;; Misc
;;;

; Comma-separated list of parameters to ignore
;ignore_startup_parameters = extra_float_digits,options

; When taking idle server connection into use,
; this query is run. If it fails, connection is closed.
;server_lifetime = 3600
;server_idle_timeout = 600

; Maximum allowed packet size
;max_packet_size = 2147483647

; Buffer size for streaming replication
;sbuf_loopcnt = 5

; Do not show remote server's connect string in logs
;log_connections = 0
;log_disconnections = 0

; Close server connection if its been connected longer
;server_lifetime = 3600

; Close server connection if its been idle longer
;server_idle_timeout = 600

; Multiplier for server_lifetime and server_idle_timeout
;suspend_timeout = 10

;;;
;;; Session-level settings
;;;

; When session pooling is not in use, but you still want to
; support server-level features like prepared statements,
; set session pooling parameters
;autodb_idle_timeout = 3600
