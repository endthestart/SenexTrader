{% extends 'settings/base.html' %}
{% block title %}Brokerage Settings - Senex Trader{% endblock %}

{% block settings_content %}
<!-- Manual Streaming Reconnect Button -->
<div class="card bg-dark border-secondary mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-1">Brokerage Connections</h4>
        <p class="text-muted mb-0">Manage your broker connections and market data.</p>
      </div>
      <button class="btn btn-sm btn-outline-secondary" id="manual-reconnect" onclick="forceReconnect()">
        <i class="bi bi-arrow-repeat"></i> Reconnect Market Data
      </button>
    </div>
    <small class="text-muted">Click reconnect if streaming status shows offline after connecting</small>
  </div>
</div>

<!-- Privacy Mode Card -->
{% if tastytrade_account %}
<div class="card bg-dark border-secondary mb-4">
  <div class="card-body">
    <h5 class="mb-3">Privacy Mode</h5>
    <p class="text-muted">Hide account balance on dashboard</p>
    <div class="form-check form-switch">
      <input
        class="form-check-input"
        type="checkbox"
        id="privacyModeToggle"
        {% if tastytrade_account.privacy_mode %}checked{% endif %}
      >
      <label class="form-check-label" for="privacyModeToggle">
        Enable Privacy Mode
      </label>
    </div>
    <small class="text-muted d-block mt-2">
      When enabled, your account balance will be hidden on the dashboard
    </small>
  </div>
</div>
{% endif %}

<!-- TastyTrade Connection Card -->
<div class="card bg-dark border-secondary mb-4">
  <div class="card-body">
    <h5 class="mb-3">TastyTrade Connection</h5>
    {% if tastytrade_account %}
      {% if tastytrade_account.is_active %}
        {% if tastytrade_account.is_configured %}
          <p class="text-muted">Status: <span class="text-success">Connected</span></p>
        {% else %}
          <p class="text-muted">Status: <span class="text-warning">Connected - Account Selection Required</span></p>
        {% endif %}
        {% with accounts=tastytrade_account.metadata.accounts %}
          {% if accounts and accounts|length > 0 %}
            {% if tastytrade_account.account_number %}
              <p class="text-muted">Current primary account: <strong>{{ tastytrade_account.account_number }}</strong></p>
              <p class="text-muted">Change primary account:</p>
            {% else %}
              <p class="text-warning">Select a primary account:</p>
            {% endif %}
            <form method="post" action="{% url 'accounts:tastytrade_select_primary' %}">
              {% csrf_token %}
              <div class="row g-2 align-items-end">
                <div class="col-md-6">
                  <select class="form-select" name="account_number" required>
                    {% for a in accounts %}
                      <option value="{{ a.account_number }}" {% if a.account_number == tastytrade_account.account_number %}selected{% endif %}>
                        {{ a.account_number }}{% if a.nickname %} - {{ a.nickname }}{% endif %}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-3">
                  <button type="submit" class="btn btn-primary">
                    {% if tastytrade_account.account_number %}Update Primary{% else %}Set Primary{% endif %}
                  </button>
                </div>
              </div>
            </form>
          {% else %}
            <p class="text-muted">No accounts available from broker.</p>
          {% endif %}
        {% endwith %}
        <form method="post" action="{% url 'accounts:tastytrade_disconnect' %}" class="mt-3">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary">Disconnect</button>
        </form>
      {% else %}
        <p class="text-muted">Status: <span class="text-danger">Disconnected</span></p>
        <a href="{% url 'accounts:tastytrade_oauth_initiate' %}" class="btn btn-primary">Connect TastyTrade</a>
      {% endif %}
    {% else %}
      <p class="text-muted">No TastyTrade connection configured.</p>
      <a href="{% url 'accounts:tastytrade_oauth_initiate' %}" class="btn btn-primary">Connect TastyTrade</a>
    {% endif %}
  </div>
</div>

<script>
// Manual streaming reconnection
function forceReconnect() {
    window.logStreamInfo('Manual reconnect triggered');

    // Reset streaming state
    window.streamersReady = false;
    window.streamersInitialized = false;

    // Close existing WebSocket if any
    if (window.streamerWebSocket) {
        try {
            window.streamerWebSocket.close();
        } catch (e) {
            window.logStreamInfo('WebSocket already closed');
        }
    }

    // Reload page for fresh initialization
    window.location.reload();
}

// Privacy Mode Toggle
document.addEventListener('DOMContentLoaded', function() {
    const privacyToggle = document.getElementById('privacyModeToggle');
    if (privacyToggle) {
        privacyToggle.addEventListener('change', async function() {
            const isEnabled = this.checked;

            try {
                const response = await fetch('{% url "accounts:api_privacy_mode_toggle" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ is_enabled: isEnabled })
                });

                const data = await response.json();

                if (data.success) {
                    window.logStreamInfo('Privacy mode updated:', isEnabled);
                } else {
                    console.error('Failed to update privacy mode:', data.error);
                    this.checked = !isEnabled;
                }
            } catch (error) {
                console.error('Error updating privacy mode:', error);
                this.checked = !isEnabled;
            }
        });
    }
});
</script>
{% endblock %}
