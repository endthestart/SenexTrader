# Redis Configuration for Senex Trader Production
# Based on Redis 7.x configuration optimized for trading application requirements

# ================================================================================
# NETWORK CONFIGURATION
# ================================================================================

# Bind to localhost only for security (adjust for production networking)
bind 127.0.0.1 ::1

# Port configuration
port 6379

# Connection timeout (0 = disable)
timeout 300

# TCP listen backlog
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

# ================================================================================
# SECURITY CONFIGURATION
# ================================================================================

# Require authentication (set a strong password in production)
# requirepass your-redis-password-here

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""
rename-command SHUTDOWN REDIS_SHUTDOWN
rename-command DEBUG ""
rename-command EVAL ""

# Protected mode (enabled by default)
protected-mode yes

# ================================================================================
# MEMORY MANAGEMENT
# ================================================================================

# Maximum memory limit (adjust based on available system memory)
# Recommended: 70-80% of available RAM for Redis-only server
maxmemory 2gb

# Memory eviction policy optimized for cache workloads
# allkeys-lru: Remove least recently used keys regardless of expiration
maxmemory-policy allkeys-lru

# Memory sampling for LRU eviction (higher = more accurate, more CPU)
maxmemory-samples 5

# ================================================================================
# PERSISTENCE CONFIGURATION (Optimized for Trading Data)
# ================================================================================

# RDB Snapshots - Critical for account state and configurations
save 900 1    # Save if at least 1 key changed in 900 seconds
save 300 10   # Save if at least 10 keys changed in 300 seconds
save 60 10000 # Save if at least 10000 keys changed in 60 seconds

# RDB file configuration
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# AOF (Append Only File) - Disable for performance in cache-heavy workload
appendonly no

# If enabling AOF, use these settings:
# appendonly yes
# appendfilename "appendonly.aof"
# appendfsync everysec
# no-appendfsync-on-rewrite no
# auto-aof-rewrite-percentage 100
# auto-aof-rewrite-min-size 64mb

# ================================================================================
# PERFORMANCE TUNING
# ================================================================================

# Disable slow operations logging for performance
slowlog-log-slower-than -1
slowlog-max-len 0

# Client output buffer limits for different client types
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Connection limits
maxclients 10000

# Hash optimization thresholds (for small datasets)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# ================================================================================
# REPLICATION CONFIGURATION (For Production HA)
# ================================================================================

# Uncomment and configure for master-replica setup
# replicaof <masterip> <masterport>
# masterauth <master-password>
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5

# ================================================================================
# CLUSTERING (For High Availability)
# ================================================================================

# Uncomment for Redis Cluster mode
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-replica-validity-factor 10

# ================================================================================
# LOGGING CONFIGURATION
# ================================================================================

# Log level (debug, verbose, notice, warning)
loglevel notice

# Log file location
logfile /var/log/redis/redis-server.log

# Syslog configuration
# syslog-enabled yes
# syslog-ident redis
# syslog-facility local0

# ================================================================================
# DATABASE CONFIGURATION
# ================================================================================

# Number of databases (default 16)
databases 16

# Database segregation for Senex Trader:
# DB 0: Default/General cache
# DB 1: Session cache
# DB 2: Celery broker
# DB 3: Celery results
# DB 4: Streaming metrics
# DB 5: Circuit breaker state
# DB 6: Rate limiting
# DB 7: Market data cache
# DB 8-15: Reserved for future use

# ================================================================================
# ADVANCED CONFIGURATION
# ================================================================================

# Latency monitoring (helps identify performance issues)
latency-monitor-threshold 100

# Memory defragmentation (Redis 4.0+)
# activedefrag yes
# active-defrag-ignore-bytes 100mb
# active-defrag-threshold-lower 10
# active-defrag-threshold-upper 100
# active-defrag-cycle-min 5
# active-defrag-cycle-max 75

# Lazy free configuration (non-blocking deletes)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# ================================================================================
# MODULES (If using Redis modules)
# ================================================================================

# loadmodule /path/to/my_module.so
# loadmodule /path/to/other_module.so

# ================================================================================
# NOTIFICATIONS (Key space events)
# ================================================================================

# Enable notifications for circuit breaker state changes
notify-keyspace-events "Ex"

# ================================================================================
# STREAMING OPTIMIZATION
# ================================================================================

# Stream configuration for real-time data
stream-node-max-bytes 4096
stream-node-max-entries 100

# ================================================================================
# TLS/SSL CONFIGURATION (For production security)
# ================================================================================

# Uncomment and configure for TLS encryption
# port 0
# tls-port 6380
# tls-cert-file /path/to/tls.crt
# tls-key-file /path/to/tls.key
# tls-dh-params-file /path/to/redis.dh
# tls-ca-cert-file /path/to/ca.crt
# tls-protocols "TLSv1.2 TLSv1.3"

# ================================================================================
# MONITORING INTEGRATION
# ================================================================================

# Enable for Prometheus monitoring
# rename-command INFO REDIS_INFO

# ================================================================================
# PRODUCTION NOTES
# ================================================================================

# 1. Memory Planning:
#    - Monitor memory usage with: redis-cli INFO memory
#    - Set maxmemory to 70-80% of available system RAM
#    - Use `used_memory_rss_human` for actual memory consumption
#
# 2. Performance Monitoring:
#    - Monitor latency: redis-cli --latency -h localhost -p 6379
#    - Check slow operations: redis-cli SLOWLOG GET 10
#    - Monitor connections: redis-cli INFO clients
#
# 3. Security Checklist:
#    - Set strong requirepass
#    - Disable dangerous commands (done above)
#    - Use TLS in production
#    - Firewall Redis port (6379)
#    - Run Redis as dedicated user
#
# 4. Backup Strategy:
#    - RDB snapshots for point-in-time recovery
#    - Consider AOF for critical data
#    - Regular backup to external storage
#
# 5. Monitoring Commands:
#    - redis-cli INFO stats
#    - redis-cli INFO memory
#    - redis-cli CLIENT LIST
#    - redis-cli CONFIG GET maxmemory-policy